- 参考资料：https://www.jianshu.com/p/c93a993f8997 （RSA密钥格式解析）

# 前言
## PKCS#1形式的公钥结构：
```text
RSAPublicKey ::= SEQUENCE {
   modulus           INTEGER,  -- n
   publicExponent    INTEGER   -- e
}
```

## PKCS#1形式的私钥结构
```text
RSAPrivateKey ::= SEQUENCE {
 version Version,
 modulus INTEGER, -- n
 publicExponent INTEGER, -- e
 privateExponent INTEGER, -- d
 prime1 INTEGER, -- p
 prime2 INTEGER, -- q
 exponent1 INTEGER, -- d mod (p-1)
 exponent2 INTEGER, -- d mod (q-1)
 coefficient INTEGER -- (inverse of q) mod p 
}
```

# start
```sh
openssl rsa -pubin -in pubkey.pem -text -noout
```
查看公钥中各参数：
```text
Public-Key: (2048 bit)
Modulus:
    00:d1:2b:63:9d:f7:59:a9:9c:9a:db:57:50:0b:bd:
    63:50:41:aa:70:f8:e7:3f:6e:a1:58:b2:3b:9a:f5:
    75:91:5c:f6:8c:f8:e5:7b:04:5b:be:bc:f7:8a:9b:
    ca:72:bf:0e:63:cb:6e:c3:53:d6:61:42:04:8c:b6:
    9e:b5:f2:0c:dc:6b:af:6c:85:e7:7e:6f:2a:a9:06:
    dc:58:68:fc:b0:f0:33:0d:eb:55:07:6e:df:1b:22:
    6e:f5:49:26:dd:2a:d3:c9:43:c8:eb:35:cb:8c:85:
    84:8e:05:ea:86:80:98:8a:18:27:01:b6:a0:dc:54:
    96:77:60:ca:c2:81:36:ad:5b:3d:9f:1c:f7:95:2b:
    89:8c:fa:af:86:3a:90:bf:d5:8d:f0:fa:3f:35:8a:
    7e:b8:bc:be:1b:fc:f1:38:72:bb:b9:fc:c2:b3:30:
    a3:8f:3f:d6:89:46:7f:ef:22:f0:27:54:9f:53:d4:
    60:e9:fe:bb:48:f1:ae:15:f7:bf:ba:93:06:96:41:
    fd:53:c4:6f:c9:71:56:0f:59:55:d8:f6:e4:19:f5:
    98:1a:9b:a3:93:71:8d:78:5f:58:65:96:07:f5:11:
    f6:cc:40:77:83:4e:05:9f:36:8e:b0:5b:ca:79:64:
    ea:2d:c8:cd:1b:13:f6:2a:29:ea:24:4a:38:76:ff:
    59:67
Exponent: 65537 (0x10001)
```

```sh
openssl rsa -in privatekey.pem -text -noout
```
查看私钥中各参数：
 ```text
Private-Key: (2048 bit)
modulus:
    00:d1:2b:63:9d:f7:59:a9:9c:9a:db:57:50:0b:bd:
    63:50:41:aa:70:f8:e7:3f:6e:a1:58:b2:3b:9a:f5:
    75:91:5c:f6:8c:f8:e5:7b:04:5b:be:bc:f7:8a:9b:
    ca:72:bf:0e:63:cb:6e:c3:53:d6:61:42:04:8c:b6:
    9e:b5:f2:0c:dc:6b:af:6c:85:e7:7e:6f:2a:a9:06:
    dc:58:68:fc:b0:f0:33:0d:eb:55:07:6e:df:1b:22:
    6e:f5:49:26:dd:2a:d3:c9:43:c8:eb:35:cb:8c:85:
    84:8e:05:ea:86:80:98:8a:18:27:01:b6:a0:dc:54:
    96:77:60:ca:c2:81:36:ad:5b:3d:9f:1c:f7:95:2b:
    89:8c:fa:af:86:3a:90:bf:d5:8d:f0:fa:3f:35:8a:
    7e:b8:bc:be:1b:fc:f1:38:72:bb:b9:fc:c2:b3:30:
    a3:8f:3f:d6:89:46:7f:ef:22:f0:27:54:9f:53:d4:
    60:e9:fe:bb:48:f1:ae:15:f7:bf:ba:93:06:96:41:
    fd:53:c4:6f:c9:71:56:0f:59:55:d8:f6:e4:19:f5:
    98:1a:9b:a3:93:71:8d:78:5f:58:65:96:07:f5:11:
    f6:cc:40:77:83:4e:05:9f:36:8e:b0:5b:ca:79:64:
    ea:2d:c8:cd:1b:13:f6:2a:29:ea:24:4a:38:76:ff:
    59:67
publicExponent: 65537 (0x10001)
privateExponent: 0
prime1: 0
prime2:
    00:ee:4e:18:98:45:cc:78:ef:ef:4a:c3:e8:1d:8a:
    ef:99:7f:73:5d:58:33:b5:c7:e8:49:4b:91:74:ae:
    21:1b:a8:82:31:e2:56:7e:e6:df:99:01:32:8e:0c:
    6d:bc:5e:24:b3:43:77:47:85:ae:7e:88:ec:40:9c:
    a1:d7:29:01:e3:2a:58:2f:29:12:60:eb:98:51:fc:
    bb:0f:ff:20:80:5d:00:00:00:00:00:00:00:00:00:
    00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:
    00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:
    00:00:00:00:00:00:00:00:00
exponent1: 0
exponent2: 0
coefficient: 0
 ```
显然私钥中是缺少参数的。
已知参数n,e,需要求出参数d

私钥中给出了一个因数的高位，尝试用高位攻击还原出p,q参数
使用在线工具：https://sagecell.sagemath.org/
运行脚本：
```python
n =26405201714915839490865227813246218372938736243516916108608439705738170543023112509150522274284238701776297205717958250714972924576706985074311737321016048409831557758205687745692399643151467933196930799657476449865271038382866908177517793954543176769652784274788769353482450910551831498252972857285424471782215525406445071432588374802623485148684255853068532820859835479998199886719945699488858505070686919320144576280217196858823521754407597888769668827432569034617434944912323704501156532854074083408527717809315663187405585840074689387865750105223058720511199252150772925124516509254841404742306560035497627834727
pbar =167343506005974003380506069679607737381940204686173214188860057004909006055220516074283090160430833007424970980655748310232878462615469792561310560310363430669700009093597847018287568821792168104155309101449005272958845979198051243961590074525335012299286501320327040500066840279750051116082809592165515132928
kbits =384  #q中末尾0的位数*4
PR.<x> = PolynomialRing(Zmod(n))
f = x + pbar
x0 = f.small_roots(X=2^kbits, beta=0.4)[0]
p = x0 + pbar
print(p)
q = n // int(p)
print(q)
```

得到结果如下：
```text
p=167343506005974003380506069679607737381940204686173214188860057004909006055220516074283090160430833007424970980655748310232878462615469792561310560310363430669700009093597847018287568821792168143170329382585883857083334915378884054389878477389765792275111293420203613159303898365894897865177093362621517279751
q=157790417717035275943197904823645145281147085252905247447260034051878691034747684303715336348507267921249655103263347914128144476912685213431110454636244692224328066884510063590700506729345331153483633231327359450199822698241355428609085077662488946173655043172957247264543259611018596088670385591091710018977
```

重新生成私钥文件

使用脚本：
```python
from Crypto.PublicKey import RSA
from Crypto.Cipher import PKCS1_OAEP
import gmpy2
e=65537
p=167343506005974003380506069679607737381940204686173214188860057004909006055220516074283090160430833007424970980655748310232878462615469792561310560310363430669700009093597847018287568821792168143170329382585883857083334915378884054389878477389765792275111293420203613159303898365894897865177093362621517279751
q=157790417717035275943197904823645145281147085252905247447260034051878691034747684303715336348507267921249655103263347914128144476912685213431110454636244692224328066884510063590700506729345331153483633231327359450199822698241355428609085077662488946173655043172957247264543259611018596088670385591091710018977
n=p*q
d=gmpy2.invert(e,(p-1)*(q-1))
privkey=RSA.construct((int(n),e,int(d)))
f = open('privkey2.pem','wb')
f.write(privkey.export_key())
f.close()
```
运行时报错
```sh
Traceback (most recent call last):
  File "genpri.py", line 3, in <module>
    import gmpy2
ImportError: dlopen(/Library/Python/3.8/site-packages/gmpy2.cpython-38-darwin.so, 2): Symbol not found: ___gmp_bits_per_limb
  Referenced from: /usr/local/opt/mpfr/lib/libmpfr.6.dylib
  Expected in: flat namespace
 in /usr/local/opt/mpfr/lib/libmpfr.6.dylib
```
无法解决==
使用python命令行将d先算出
```sh
>>> d=gmpy2.invert(65537,167343506005974003380506069679607737381940204686173214188860057004909006055220516074283090160430833007424970980655748310232878462615469792561310560310363430669700009093597847018287568821792168143170329382585883857083334915378884054389878477389765792275111293420203613159303898365894897865177093362621517279750*157790417717035275943197904823645145281147085252905247447260034051878691034747684303715336348507267921249655103263347914128144476912685213431110454636244692224328066884510063590700506729345331153483633231327359450199822698241355428609085077662488946173655043172957247264543259611018596088670385591091710018976)
>>> print(d)
9773675682445464918586580043238579203972532520488172344822367981167837115410450024367507962366099492312577896704246932966779272844069121930095276316175706888104336910425463071776343600463376552535074039673635712968731325039162388552576813796013067154099779375586706241921010943255967293050042198636340187016267102805863432621479383935006799125824213909766914931199915893387563924135129685115755127420402258823874728044643473536945409406157522093632764353499312446352234673949161644998035040316990946448354876688436637341532414726297084788627164931779656728212620316242680523452535775566473522741450484289514716697473
>>> 
```
改写脚本：
```python
from Crypto.PublicKey import RSA
from Crypto.Cipher import PKCS1_OAEP

e=65537
p=167343506005974003380506069679607737381940204686173214188860057004909006055220516074283090160430833007424970980655748310232878462615469792561310560310363430669700009093597847018287568821792168143170329382585883857083334915378884054389878477389765792275111293420203613159303898365894897865177093362621517279751
q=157790417717035275943197904823645145281147085252905247447260034051878691034747684303715336348507267921249655103263347914128144476912685213431110454636244692224328066884510063590700506729345331153483633231327359450199822698241355428609085077662488946173655043172957247264543259611018596088670385591091710018977
n=p*q
d=9773675682445464918586580043238579203972532520488172344822367981167837115410450024367507962366099492312577896704246932966779272844069121930095276316175706888104336910425463071776343600463376552535074039673635712968731325039162388552576813796013067154099779375586706241921010943255967293050042198636340187016267102805863432621479383935006799125824213909766914931199915893387563924135129685115755127420402258823874728044643473536945409406157522093632764353499312446352234673949161644998035040316990946448354876688436637341532414726297084788627164931779656728212620316242680523452535775566473522741450484289514716697473
privkey=RSA.construct((int(n),e,int(d)))
f = open('privkey2.pem','wb')
f.write(privkey.export_key())
f.close()
```
成功生成密钥文件

使用密钥解密密文
```python
from Crypto.PublicKey import RSA
from Crypto.Cipher import PKCS1_OAEP
import base64

ciphertext=open(r"flag.enc","r").read()
privatekey=open(r"privkey2.pem").read()

key=RSA.importKey(privatekey)
cipher=PKCS1_OAEP.new(key)
message=cipher.decrypt(base64.b64decode(ciphertext))

print(message)
```
成功得到flag
![pasted-image](images/_/20210529170845.png)

